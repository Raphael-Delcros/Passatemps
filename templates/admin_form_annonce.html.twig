{% extends 'base_template.html.twig' %}

{% block body %}
	<div class="container mt-5">
		<div class="card shadow">
			<div class="card-header bg-warning">
				<h2>Modifier l'annonce #{{ annonce.idAnnonce }}</h2>
			</div>
			<div class="card-body">
				<form method="POST" action="index.php?controleur=admin&methode=modifierAnnonce">
					<input type="hidden" name="idAnnonce" value="{{ annonce.idAnnonce }}">
					<input type="hidden" name="idCompteVendeur" value="{{ annonce.idCompteVendeur }}">
					<input type="hidden" name="urlPhoto" value="{{ annonce.url }}">
					<input type="hidden" name="datePub" value="{{ annonce.datePub }}">

					<div class="row mb-3">
						<div class="col-md-6">
							<label class="form-label">Titre</label>
							<input type="text" name="titre" class="form-control" value="{{ annonce.titre }}" required>
						</div>
						<div class="col-md-6">
							<label class="form-label">Jeu</label>
							<div class="position-relative">
								<input type="text" id="jeu" class="form-control" value="{{ annonce.nomJeu }}" required>
								<input type="hidden" name="idJeu" id="idJeu" value="{{ annonce.idJeu }}">
								<ul id="resultats" class="list-group position-absolute w-100" style="z-index:2000; display:none;"></ul>
							</div>
						</div>
					</div>

					<div class="mb-3">
						<label class="form-label">Description</label>
						<textarea name="description" class="form-control" rows="3">{{ annonce.description }}</textarea>
					</div>

					<div class="row mb-3">
						<div class="col-md-4">
							<label class="form-label">Prix (€)</label>
							<input type="number" step="0.01" name="prix" class="form-control" value="{{ annonce.prix }}">
						</div>
						<div class="col-md-4">
							<label class="form-label">État du jeu</label>
							<select name="etatJeu" class="form-select">
								<option {% if annonce.etatJeu == 'Neuf' %} selected {% endif %}>Neuf</option>
								<option {% if annonce.etatJeu == 'Très bon état' %} selected {% endif %}>Très bon état</option>
								<option {% if annonce.etatJeu == 'Bon état' %} selected {% endif %}>Bon état</option>
							</select>
						</div>
						<div class="col-md-4">
							<label class="form-label">État Vente</label>
							<select name="etatVente" class="form-select">
								<option {% if annonce.etatVente == 'en Vente' %} selected {% endif %}>en Vente</option>
								<option {% if annonce.etatVente == 'Vendu' %} selected {% endif %}>Vendu</option>
							</select>
						</div>
					</div>
					<div class="d-flex justify-content-between">
						<a href="index.php?controleur=admin&methode=listeAnnonces" class="btn btn-secondary">Annuler</a>
						<button type="submit" class="btn btn-primary">Enregistrer les modifications</button>
					</div>
				</form>
			</div>
		</div>
	</div>
{% endblock %}

{% block script %}
	<script>
		(() => {
let inputJeu = document.getElementById('jeu');
let resultats = document.getElementById('resultats');


// vider et cacher
function clearResults() {
resultats.innerHTML = '';
resultats.style.display = 'none';
}

// Affiche les résultats (tableau d'objets {idJeu, nom})
function showResults(items) {
resultats.innerHTML = '';
if (! items.length) {
clearResults();
return;
}
items.forEach(it => {
let li = document.createElement('li');
li.className = 'list-group-item list-group-item-action';
li.textContent = it.nom;
li.style.cursor = 'pointer';
li.addEventListener('click', () => {
inputJeu.value = it.nom;
document.getElementById('idJeu').value = it.idJeu;
clearResults();
});
resultats.appendChild(li);
});
resultats.style.display = 'block';
}

// Requête au serveur (debounce simple)
let timer = null;
inputJeu.addEventListener('input', () => {
let q = inputJeu.value.trim();
if (q.length === 0) {
clearResults();
return;
}

if (timer) 
clearTimeout(timer);



timer = setTimeout(() => {
fetch (`index.php?controleur=Jeu&methode=autocomplete&q=${
encodeURIComponent(q)
}`).then(resp => {
if (!resp.ok) 
throw new Error('Réponse réseau : ' + resp.status);



return resp.json();
}).then(data => { // data doit être un tableau d'obj {idJeu, nom}
showResults(Array.isArray(data) ? data : []);
}).catch(err => {
console.error('Autocomplete fetch error:', err);
clearResults();
});
}, 180); // 180ms debounce
});

// Gestion appui sur Entrée
inputJeu.addEventListener('keydown', (e) => { // navigation clavier (flèche haut/bas)
if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
let items = Array.from(resultats.querySelectorAll('li'));
if (! items.length) 
return;



e.preventDefault();
let idx = items.findIndex(i => i.classList.contains('active'));
if (e.key === 'ArrowDown') 
idx = (idx + 1) % items.length;
 else 
idx = (idx - 1 + items.length) % items.length;
 items.forEach(i => i.classList.remove('active'));
items[idx].classList.add('active');
items[idx].scrollIntoView({block: 'nearest'});
}

// sélection avec Entrée
if (e.key === 'Enter') {
let active = resultats.querySelector('li.active');
if (active) {
e.preventDefault(); // empêcher l'envoi du formulaire
active.click();
}
}
});


// Clic en dehors : fermer
document.addEventListener('click', (ev) => {
if (! inputJeu.contains(ev.target) && ! resultats.contains(ev.target)) {
clearResults();
}
});
})();
	</script>
{% endblock %}

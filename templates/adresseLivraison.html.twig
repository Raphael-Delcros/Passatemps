{% extends 'base_template.html.twig' %}

{% block title %}
	{{constantes.application.website_name}}
	- Adresse de Livraison
{% endblock %}

{% block body %}
	<form method="POST" action="index.php?controleur=paiement&methode=payer" class="row g-3 position-relative" autocomplete="off" enctype="multipart/form-data">
		<h1 class="text-center">Acheter votre jeu</h1>
		<p>
			<b>Adresse de livraison</b>→ paiement → récapituatif</p>
		<input type="hidden" name="controleur" value="paiement">
		<input type="hidden" name="methode" value="afficher">
		<input type="hidden" name="idAnnonce" value="{{ annonce.idAnnonce }}">

		<div class="row">
			<div class=" col mt-2 bg-light p-3 border border-2 rounded">
				<div class="text-start">
					<a class="btn btn-outline-secondary mb-3" href="index.php?controleur=Annonce&methode=afficher&id={{ annonce.idAnnonce }}">
						<i class="bi bi-arrow-left">
							Retour
						</i>
					</a>
				</div>
				<h3 class="text-center">Adresse de livraison</h3>
				<div class="row">
					<div class="row">
						<div class="row">
							<div class="col-3">
								<label for="codePostal" class="form-label required">Code Postal</label>
								<input type="text" id="codePostal" class="form-control shadow-sm" name="codePostal" list="liste-codes" placeholder="33000" value="{{ donnees.codePostal ?? '' }}" required autocomplete="off">
								<datalist id="liste-codes"></datalist>
							</div>
							<div class="col">
								<label for="ville" class="form-label required">Ville</label>
								<input type="text" id="ville" class="form-control shadow-sm  capitalize-input" name="ville" list="liste-villes" placeholder="Bordeaux" value="{{ donnees.ville ?? '' }}" required autocomplete="off">
								<datalist id="liste-villes"></datalist>
							</div>
						</div>
					</div>
				</div>
				<div class="row mt-2">
					<div class="col">
						<label for="adresse" class="form-label required">Adresse</label>
						<input type="text" class="form-control shadow-sm" name="adresse" placeholder="12 rue de la paix" value="{{ donnees.adresse ?? '' }}" required>
					</div>
					<div class="col">
						<label for="complementAdresse" class="form-label">Complement d'adresse</label>
						<input type="text" class="form-control shadow-sm" name="complementAdresse" placeholder="Batiment A, Appartement 3" value="{{ donnees.complementAdresse ?? '' }}">
					</div>
				</div>
				<div class="row">
					<div class="col mt-3 text-end">
						<button type="submit" class="btn btn-primary mt-3" href="index.php?controleur=paiement&methode=payer&id={{ annonce.idAnnonce }}">Continuer vers le paiement</button>
					</div>
				</div>
			</div>

			<div class="col-1"></div>

			<div class="col-3 bg-light p-3 border border-2 rounded">
				<h3>{{ jeu.nom}}</h3>
				<p>
					<strong>Titre de l'annonce :</strong>
					{{ annonce.titre }}</p>
				<p>
					<strong>Prix :</strong>
					{{ annonce.prix }}
					€</p>
				<p>
					<strong>Etat du jeu :</strong>
					{{ annonce.etatJeu }}</p>
				<p>
					<strong>Description :</strong>
					{{annonce.description}}</p>
			</div>
		</div>

		<div class="row mt-2">
			<div class="col mt-2">
				{% if erreurs is defined and erreurs|length > 0 %}
					<div class="alert alert-danger mt-3">
						<ul class="mb-0">
							{% for erreur in erreurs %}
								<li>{{ erreur }}</li>
							{% endfor %}
						</ul>
					</div>
				{% endif %}
			</div>
		</div>
	</form>
{% endblock %}
{% block script %}
	<script>
		document.addEventListener('DOMContentLoaded', function () {
const cpInput = document.getElementById('codePostal');
const villeInput = document.getElementById('ville');
const cpList = document.getElementById('liste-codes');
const villeList = document.getElementById('liste-villes');

// SENS : Code Postal -> Ville
cpInput.addEventListener('input', function () {
if (this.value.length === 5) {
fetch (`https://geo.api.gouv.fr/communes?codePostal=${
this.value
}&fields=nom`).then(r => r.json()).then(data => {
villeList.innerHTML = "";
if (data.length > 0) {
data.forEach(c => {
let opt = document.createElement('option');
opt.value = c.nom;
villeList.appendChild(opt);
});
if (data.length === 1) 
villeInput.value = data[0].nom;

}
});
}
});

// SENS INVERSE : Ville -> Code Postal
villeInput.addEventListener('input', function () {
if (this.value.length >= 3) { // On cherche à partir de 3 lettres
fetch (`https://geo.api.gouv.fr/communes?nom=${
this.value
}&fields=codesPostaux`).then(r => r.json()).then(data => {
cpList.innerHTML = "";
// L'API renvoie souvent plusieurs communes si le nom est partiel
if (data.length > 0) {
data.forEach(commune => {
commune.codesPostaux.forEach(cp => {
let opt = document.createElement('option');
opt.value = cp;
opt.textContent = commune.nom; 
cpList.appendChild(opt);
});
});
// Si une seule ville correspond exactement, on met le 1er CP
let match = data.find(c => c.nom.toLowerCase() === this.value.toLowerCase());
if (match && match.codesPostaux.length === 1) {
cpInput.value = match.codesPostaux[0];
}
}
});
}
});
});
	</script>
{% endblock %}

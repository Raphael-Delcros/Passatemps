{% extends 'base_template.html.twig' %}

{% block title %}
	{{constantes.application.website_name}}
	- Vente
{% endblock %}

{% block body %}
	<div class="container my-5">
<div class="card shadow-lg border-0 p-3">
	<form method="POST" action="index.php?controleur=vendre&methode=recap" class="row g-3 position-relative" autocomplete="off" novalidate enctype="multipart/form-data">
		<h1>Vendre</h1>
		<input type="hidden" name="controleur" value="vendre">
		<input type="hidden" name="methode" value="confirmerVente">
		<input
		type="hidden" name="idJeu" id="idJeu">


		{# Titre de l'annonce #}
		<div class="row mt-2">
			<div class="col mt-2">
				<label for="titre" class="form-label required">Titre</label>
				<div class="position-relative">
					<input 
					type="text" 
					class="form-control" 
					name="titre" 
					placeholder="Nom de l'annonce" 
					title="Entrez le nom de l'annonce"
					{ % if donnees.titre is defined %} value="{{ donnees.titre }}" { % endif %}
					required>
				</div>
			</div>

			{# Nom du jeu #}
			<div class="col mt-2">
				<label for="jeu" class="form-label required">Jeu</label>
				<div class="position-relative">
					<input type="text" 
					id="jeu" 
					class="form-control" 
					name="jeu" 
					placeholder="Nom du jeu" 
					title="Entrez le nom du jeu" 
					spellcheck="true" 
					{# { % if donnees.jeu is defined %} value="{{ donnees.jeu }}" { % endif %} 
					
					Commenté car le validator fonctionne pas avec l'autocomplete
					
					#}
					required>

					<ul id="resultats" class="list-group position-absolute w-100" style="z-index:2000; display:none; max-height:300px; overflow:auto; top:100%; left:0;"></ul>
				</div>
			</div>
		</div>

		{# Description du jeu #}
		<div class="row mt-2">
			<label for="description" class="form-label required">Description</label>
			<div class="position-relative">
				<textarea 
				class="form-control" 
				name="description" 
				placeholder="Description de l'annonce" 
				title="Description de l'annonce" 
				spellcheck="true"
				{# Seul moyen trouvé pour pré-remplir le textarea #}
				required>{{ donnees.description is defined ? donnees.description : '' }}</textarea> 
			</div>
		</div>

		{# Prix de l'annonce #}
		<div class="row mt-2">
			<div class="col mt-2">
				<label for="prix" class="form-label required">Prix</label>
				<div class="position-relative">
					<input 
					type="text" 
					class="form-control" 
					name="prix" 
					placeholder="12.50" 
					title="Prix de l'annonce" 
					{ % if donnees.prix is defined %} value="{{ donnees.prix }}" { % endif %}
					required>
				</div>
			</div>

			{# Etat du jeu #}
			<div class="col mt-2">

				<label for="etatJeu" class="form-label required">Etat du jeu</label>
				<div class="position-relative">
					<select class="form-select" name="etatJeu" title="Etat du jeu" required>
						<option selected>Choisir</option>
						<option>Neuf</option>
						<option>Très bon état</option>
						<option>Bon état</option>
						<option>Abimé</option>
						<option>Manque des pieces</option>
					</select>
				</div>
			</div>
		</div>
		{# Photos du jeu #}
		<div class="row mt-2">
			<div class="col mt-2">
				<label for="photos" class="form-label required">Photos de l'annonce</label>
				<input type="file" class="form-label" name="photos" accept=".png,.jpeg,.jpg" title="Photos de l'annonce" required>
			</div>
			{# Confirmation #}
			<div class="col align-items-end">
				<div class="d-grid gap-2 d-md-flex justify-content-md-end">
					<button type="submit" class="btn btn-primary me-md-2">Publier l'annonce</button>
				</div>
			</div>
		</div>

		{{ message }}
	</form>
	{% if erreurs is defined and erreurs|length > 0 %}
		<div class="alert alert-danger mt-3">
			<ul class="mb-0">
				{% for erreur in erreurs %}
					<li>{{ erreur }}</li>
				{% endfor %}
			</ul>
		</div>
		</div>
		</div>
	{% endif %}
{% endblock %}

{% block script %}
	<script>
		(() => {
let inputJeu = document.getElementById('jeu');
let resultats = document.getElementById('resultats');


// vider et cacher
function clearResults() {
resultats.innerHTML = '';
resultats.style.display = 'none';
}

// Affiche les résultats (tableau d'objets {idJeu, nom})
function showResults(items) {
resultats.innerHTML = '';
if (! items.length) {
clearResults();
return;
}
items.forEach(it => {
let li = document.createElement('li');
li.className = 'list-group-item list-group-item-action';
li.textContent = it.nom;
li.style.cursor = 'pointer';
li.addEventListener('click', () => {
inputJeu.value = it.nom;
document.getElementById('idJeu').value = it.idJeu;
clearResults();
});
resultats.appendChild(li);
});
resultats.style.display = 'block';
}

// Requête au serveur (debounce simple)
let timer = null;
inputJeu.addEventListener('input', () => {
let q = inputJeu.value.trim();
if (q.length === 0) {
clearResults();
return;
}

if (timer) 
clearTimeout(timer);



timer = setTimeout(() => {
fetch (`index.php?controleur=Jeu&methode=autocomplete&q=${
encodeURIComponent(q)
}`).then(resp => {
if (!resp.ok) 
throw new Error('Réponse réseau : ' + resp.status);



return resp.json();
}).then(data => { // data doit être un tableau d'obj {idJeu, nom}
showResults(Array.isArray(data) ? data : []);
}).catch(err => {
console.error('Autocomplete fetch error:', err);
clearResults();
});
}, 180); // 180ms debounce
});

// Gestion appui sur Entrée
inputJeu.addEventListener('keydown', (e) => { // navigation clavier (flèche haut/bas)
if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
let items = Array.from(resultats.querySelectorAll('li'));
if (! items.length) 
return;



e.preventDefault();
let idx = items.findIndex(i => i.classList.contains('active'));
if (e.key === 'ArrowDown') 
idx = (idx + 1) % items.length;
 else 
idx = (idx - 1 + items.length) % items.length;
 items.forEach(i => i.classList.remove('active'));
items[idx].classList.add('active');
items[idx].scrollIntoView({block: 'nearest'});
}

// sélection avec Entrée
if (e.key === 'Enter') {
let active = resultats.querySelector('li.active');
if (active) {
e.preventDefault(); // empêcher l'envoi du formulaire
active.click();
}
}
});


// Clic en dehors : fermer
document.addEventListener('click', (ev) => {
if (! inputJeu.contains(ev.target) && ! resultats.contains(ev.target)) {
clearResults();
}
});
})();
	</script>
{% endblock %}
